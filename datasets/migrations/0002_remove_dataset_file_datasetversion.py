# Generated by Django 5.0 on 2024-02-03 21:59

import datasets.models
import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models

# ======================================================================================================================
# Migration Functions
# ======================================================================================================================

def migrate_dataset_file_to_dataset_version(apps, schema_editor):
    dataset_model = apps.get_model('datasets', 'Dataset')
    dataset_version_model = apps.get_model('datasets', 'DatasetVersion')

    for dataset in dataset_model.objects.all():
        dataset_version = dataset_version_model(dataset=dataset, file=dataset.file)
        dataset_version.save()


def migrate_dataset_version_to_dataset_file(apps, schema_editor):
    dataset_version_model = apps.get_model('datasets', 'DatasetVersion')

    for dataset_version in dataset_version_model.objects.all():
        dataset = dataset_version.dataset
        dataset.file = dataset_version.file
        dataset.save()

# ======================================================================================================================
# Migration
# ======================================================================================================================

class Migration(migrations.Migration):

    dependencies = [
        ('datasets', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='DatasetVersion',
            fields=[
                ('id', models.AutoField(primary_key=True, serialize=False)),
                ('date', models.DateTimeField(default=django.utils.timezone.now, help_text='Date de la version du jeu de données.')),
                ('file', models.FileField(help_text='Fichier de la version du jeu de données.', upload_to=datasets.models.dataset_version_filepath)),
                ('dataset', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='versions', to='datasets.dataset')),
            ],
            options={
                'verbose_name': 'Version de jeu de données',
                'verbose_name_plural': 'Versions de jeux de données',
                'ordering': ['-date'],
            },
        ),

        # Before removing the field dataset.file, we add a new version for each dataset and copy the file to the new version
        migrations.RunPython(migrate_dataset_file_to_dataset_version,
                             reverse_code=migrate_dataset_version_to_dataset_file),

        # Remove the field dataset.file
        migrations.RemoveField(
            model_name='dataset',
            name='file',
        ),
    ]
